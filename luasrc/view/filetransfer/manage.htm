<%#
 Copyright 2024 DustReliant
 Licensed to the public under the MIT License.
-%>

<%+header%>

<div class="cbi-map">
    <h2 name="content"><%:File Management%></h2>

    <div class="cbi-section">
        <div class="cbi-section-descr"><%:Browse and manage system files%></div>
        
        <!-- ç®€æ´çš„åœ°å€æ  -->
        <div class="path-bar">
            <input type="text" id="current-path" value="/" placeholder="<%:Enter path...%>" class="path-input">
            <button class="btn btn-primary" onclick="navigateToPath()"><%:Go%></button>
            <button class="btn btn-secondary" onclick="refreshFiles()"><%:Refresh%></button>
        </div>

        <!-- ç®€æ´çš„æ–‡ä»¶åˆ—è¡¨ -->
        <div class="file-browser">
            <div class="file-list" id="file-list">
                <div class="loading" id="loading"><%:Loading...%></div>
            </div>
        </div>
        
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <span id="file-count">0 <%:items%></span>
        </div>
    </div>
</div>

<style>
.cbi-map {
    background: #f5f5f5;
    min-height: 100vh;
    padding: 20px;
}

.cbi-section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 20px;
    margin-bottom: 20px;
}

.cbi-section-descr {
    color: #666;
    margin-bottom: 20px;
    text-align: center;
}

/* åœ°å€æ  */
.path-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    align-items: center;
}

.path-input {
    flex: 1;
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 5px;
    font-family: monospace;
    font-size: 14px;
}

.path-input:focus {
    border-color: #007bff;
    outline: none;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn:hover {
    opacity: 0.9;
}

/* æ–‡ä»¶æµè§ˆå™¨ */
.file-browser {
    border: 1px solid #ddd;
    border-radius: 5px;
    background: white;
    min-height: 400px;
}

.file-list {
    padding: 0;
}

.file-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background-color 0.2s;
}

.file-item:hover {
    background: #f8f9fa;
}

.file-item:last-child {
    border-bottom: none;
}

.file-item.folder {
    background: #fff9e6;
}

.file-item.folder:hover {
    background: #e6f3ff;
}

.file-icon {
    font-size: 20px;
    margin-right: 12px;
    width: 24px;
    text-align: center;
}

.file-name {
    flex: 1;
    font-weight: 500;
    color: #333;
}

.file-info {
    display: flex;
    gap: 20px;
    color: #666;
    font-size: 12px;
    font-family: monospace;
}

.file-size {
    min-width: 80px;
    text-align: right;
}

.file-date {
    min-width: 120px;
}

.file-actions {
    display: flex;
    gap: 5px;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #666;
}

.status-bar {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
    color: #666;
    font-size: 14px;
}

/* å“åº”å¼ */
@media (max-width: 768px) {
    .path-bar {
        flex-direction: column;
    }
    
    .file-info {
        display: none;
    }
    
    .file-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .file-actions {
        width: 100%;
        justify-content: flex-end;
    }
}
</style>

<script>
let currentPath = '/';

// é”™è¯¯æ—¥å¿—è®°å½•å‡½æ•°
function logError(type, message, details) {
    const errorData = {
        type: type || 'error',
        message: message || 'Unknown error',
        details: details || '',
        url: window.location.href
    };
    
    console.log('Logging error:', errorData); // è°ƒè¯•ä¿¡æ¯
    
    // å‘é€åˆ°è°ƒè¯•APIï¼ˆä¸éœ€è¦è®¤è¯ï¼‰
    fetch('/cgi-bin/luci/filetransfer/debug/log_error', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: Object.keys(errorData).map(key => 
            encodeURIComponent(key) + '=' + encodeURIComponent(errorData[key])
        ).join('&')
    }).then(response => {
        console.log('Error logged successfully:', response.status);
    }).catch(err => {
        console.error('Failed to log error:', err);
    });
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    refreshFiles();
});

// å¯¼èˆªåˆ°æŒ‡å®šè·¯å¾„
function navigateTo(path) {
    // è§„èŒƒåŒ–è·¯å¾„
    path = path.replace(/\/+/g, '/');
    if (path !== '/' && path.endsWith('/')) {
        path = path.slice(0, -1);
    }
    
    currentPath = path;
    document.getElementById('current-path').value = path;
    refreshFiles();
}

// ä»åœ°å€æ å¯¼èˆª
function navigateToPath() {
    const path = document.getElementById('current-path').value;
    navigateTo(path);
}

// å¯¼èˆªåˆ°æ–‡ä»¶å¤¹ï¼ˆä¸“é—¨ç”¨äºç‚¹å‡»æ–‡ä»¶å¤¹ï¼‰
function navigateToFolder(path) {
    console.log('Navigating to folder:', path); // è°ƒè¯•ä¿¡æ¯
    navigateTo(path);
}

// åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
function refreshFiles() {
    const fileList = document.getElementById('file-list');
    
    fileList.innerHTML = '<div class="loading"><%:Loading...%></div>';
    
    // å‘é€è¯·æ±‚è·å–æ–‡ä»¶åˆ—è¡¨
    fetch('/cgi-bin/luci/admin/system/filetransfer/browse_files', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `path=${encodeURIComponent(currentPath)}`
    })
    .then(response => {
        if (!response.ok) {
            logError('HTTP_ERROR', `HTTP ${response.status}: ${response.statusText}`, 'browse_files APIè¯·æ±‚å¤±è´¥');
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('API Response:', data); // è°ƒè¯•ä¿¡æ¯
        if (data.status === 'success') {
            displayFiles(data.files || []);
            updateFileCount(data.files ? data.files.length : 0);
        } else {
            logError('API_ERROR', 'APIè¿”å›é”™è¯¯çŠ¶æ€', JSON.stringify(data));
            throw new Error('API returned error status');
        }
    })
    .catch(error => {
        console.error('Error loading files:', error);
        logError('FETCH_ERROR', error.message, `è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼Œå½“å‰è·¯å¾„: ${currentPath}`);
        // æ˜¾ç¤ºç¤ºä¾‹æ–‡ä»¶åˆ—è¡¨ä½œä¸ºfallback
        displaySampleFiles();
    });
}

// æ˜¾ç¤ºç¤ºä¾‹æ–‡ä»¶åˆ—è¡¨ï¼ˆå½“APIä¸å¯ç”¨æ—¶ï¼‰
function displaySampleFiles() {
    const sampleFiles = [];
    
    // å¦‚æœä¸æ˜¯æ ¹ç›®å½•ï¼Œæ·»åŠ è¿”å›ä¸Šçº§ç›®å½•
    if (currentPath !== '/') {
        sampleFiles.push({
            name: '..',
            type: 'directory',
            size: 0,
            modified: '',
            permissions: 'drwxr-xr-x',
            path: currentPath.split('/').slice(0, -1).join('/') || '/'
        });
    }
    
    // æ·»åŠ ç¤ºä¾‹æ–‡ä»¶å¤¹å’Œæ–‡ä»¶
    if (currentPath === '/') {
        sampleFiles.push(
            { name: 'bin', type: 'directory', size: 0, modified: '2024-06-29 09:30', permissions: 'drwxr-xr-x' },
            { name: 'etc', type: 'directory', size: 0, modified: '2024-06-29 09:25', permissions: 'drwxr-xr-x' },
            { name: 'tmp', type: 'directory', size: 0, modified: '2024-06-29 10:05', permissions: 'drwxrwxrwx' },
            { name: 'usr', type: 'directory', size: 0, modified: '2024-06-29 09:20', permissions: 'drwxr-xr-x' },
            { name: 'var', type: 'directory', size: 0, modified: '2024-06-29 09:15', permissions: 'drwxr-xr-x' }
        );
    }
    
    displayFiles(sampleFiles);
    updateFileCount(sampleFiles.length);
}

// æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
function displayFiles(files) {
    const fileList = document.getElementById('file-list');
    
    if (files.length === 0) {
        fileList.innerHTML = '<div class="loading"><%:No files found%></div>';
        return;
    }

    let html = '';
    files.forEach(file => {
        const isFolder = file.type === 'directory';
        const icon = isFolder ? 'ğŸ“' : 'ğŸ“„';
        const sizeDisplay = isFolder ? '-' : formatFileSize(file.size);
        
        // æ„å»ºç›®æ ‡è·¯å¾„
        let targetPath;
        if (file.name === '..') {
            // ä¸Šçº§ç›®å½• - ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„pathå­—æ®µæˆ–è€…è‡ªå·±è®¡ç®—
            if (file.path) {
                targetPath = file.path;
            } else {
                const parts = currentPath.split('/').filter(p => p);
                parts.pop();
                targetPath = parts.length > 0 ? '/' + parts.join('/') : '/';
            }
        } else {
            // æ™®é€šæ–‡ä»¶å¤¹æˆ–æ–‡ä»¶ - ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„pathå­—æ®µ
            if (file.path) {
                targetPath = file.path;
            } else {
                targetPath = currentPath === '/' ? '/' + file.name : currentPath + '/' + file.name;
            }
        }
        
        html += `
            <div class="file-item ${isFolder ? 'folder' : ''}" ${isFolder ? `onclick="navigateToFolder('${targetPath}')" title="ç‚¹å‡»æ‰“å¼€æ–‡ä»¶å¤¹"` : ''}>
                <div class="file-icon">${icon}</div>
                <div class="file-name">${file.name}</div>
                <div class="file-info">
                    <div class="file-size">${sizeDisplay}</div>
                    <div class="file-date">${file.modified}</div>
                </div>
                ${!isFolder ? `
                <div class="file-actions">
                    <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); downloadFile('${file.name}')"><%:Download%></button>
                    <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteFile('${file.name}')"><%:Delete%></button>
                </div>
                ` : ''}
            </div>
        `;
    });
    
    fileList.innerHTML = html;
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// æ›´æ–°æ–‡ä»¶è®¡æ•°
function updateFileCount(count) {
    document.getElementById('file-count').textContent = `${count} <%:items%>`;
}

// æ–‡ä»¶æ“ä½œ
function downloadFile(filename) {
    window.location.href = `/cgi-bin/luci/admin/system/filetransfer/download?filename=${encodeURIComponent(filename)}`;
}

function deleteFile(filename) {
    if (confirm(`<%:Are you sure you want to delete%> "${filename}"?`)) {
        fetch('/cgi-bin/luci/admin/system/filetransfer/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `filename=${encodeURIComponent(filename)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                refreshFiles();
            } else {
                alert('åˆ é™¤å¤±è´¥');
            }
        })
        .catch(error => {
            console.error('åˆ é™¤é”™è¯¯:', error);
            alert('åˆ é™¤å¤±è´¥');
        });
    }
}
</script>

<%+footer%> 